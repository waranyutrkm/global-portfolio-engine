<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Global Portfolio Engine v34.0 ‚Äî Deterministic Quant Lab</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ================= LIBRARIES ================= -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {
      fontFamily: {
        sans: ['Sarabun','sans-serif'],
        mono: ['JetBrains Mono','monospace']
      },
      colors: {
        brand: { 500:'#FCD535', 600:'#E5B80B' },
        dark: { 900:'#181A20', 800:'#1E2329', 700:'#2B3139' }
      }
    }
  }
}
</script>

<style>
body { transition: background-color .3s, color .3s; }
.glass {
  background: rgba(255,255,255,.98);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(0,0,0,.05);
}
.dark .glass {
  background: rgba(30,35,41,.98);
  border-color: #2B3139;
}
.mono { font-family: 'JetBrains Mono', monospace; }
.custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #FCD535; border-radius: 10px; }

.heatmap-table { border-collapse: separate; border-spacing: 1px; width: 100%; }
.heatmap-table th { font-size: 10px; padding: 6px 2px; color: #848E9C; text-transform: uppercase; }
.heatmap-table td { height: 32px; text-align: center; font-family: 'JetBrains Mono'; font-size: 10px; border-radius: 2px; min-width: 38px; }

.step-card { border-left: 4px solid #FCD535; padding-left: 20px; margin-bottom: 2.5rem; }
.formula-box { background: rgba(252, 213, 53, 0.08); border: 1px solid rgba(252, 213, 53, 0.3); border-radius: 12px; }

/* Tooltip Styles */
.tooltip-container { position: relative; display: inline-block; cursor: help; }
.tooltip-icon { font-size: 10px; background: #eee; color: #848E9C; width: 14px; height: 14px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-left: 4px; transition: all 0.2s; }
.dark .tooltip-icon { background: #333; color: #94a3b8; }
.tooltip-container:hover .tooltip-icon { background: #FCD535; color: black; }

.tooltip-text { 
  visibility: hidden; width: 220px; background-color: #1E2329; color: #fff; text-align: left; border-radius: 8px; padding: 10px; 
  position: absolute; z-index: 100; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; 
  font-size: 11px; font-weight: 400; font-family: 'Sarabun', sans-serif; line-height: 1.5; box-shadow: 0 4px 15px rgba(0,0,0,0.2); pointer-events: none;
}
.dark .tooltip-text { background-color: #F0B90B; color: #181A20; }
.tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1E2329 transparent transparent transparent; }
.dark .tooltip-text::after { border-color: #F0B90B transparent transparent transparent; }
.tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

.strat-card-info { border: 1px solid #ddd; border-radius: 20px; padding: 24px; background: rgba(255,255,255,0.5); position: relative; overflow: hidden; }
.dark .strat-card-info { border-color: #333; background: rgba(0,0,0,0.2); }
.strat-card-info::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: #FCD535; }

/* Table Sorting & Filter Styles */
th.sortable { cursor: pointer; transition: background 0.2s; position: relative; }
th.sortable:hover { background: rgba(252, 213, 53, 0.1); }
th.sortable i { font-size: 10px; margin-left: 4px; opacity: 0.5; }
th.sorted-asc i, th.sorted-desc i { opacity: 1; color: #FCD535; }

.filter-input { width: 100%; font-size: 9px; padding: 4px 6px; border-radius: 6px; border: 1px solid #ddd; background: white; color: #333; outline: none; margin-top: 4px; font-family: 'JetBrains Mono'; }
.dark .filter-input { background: #1E2329; border-color: #444; color: #EAECEF; }

.kpi-bench-val { font-size: 0.72rem; color: #94a3b8; font-weight: 700; margin-top: 0.3rem; border-top: 1px dashed rgba(148, 163, 184, 0.3); padding-top: 0.3rem; display: block; }

/* Sidebar UI Refinement */
.sidebar-section { margin-bottom: 20px; }
.opt-label { font-size: 10px; font-weight: 700; color: #848E9C; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block; }
.opt-input { background: rgba(255,255,255,0.9); border: 1.5px solid #eee; border-radius: 12px; padding: 10px 14px; font-family: 'JetBrains Mono'; font-size: 12px; outline: none; transition: all 0.2s; width: 100%; }
.dark .opt-input { background: #1E2329; border-color: #333; color: #EAECEF; }
.opt-input:focus { border-color: #FCD535; box-shadow: 0 0 0 3px rgba(252, 213, 53, 0.1); }
</style>
</head>

<body class="bg-[#F0F3F5] dark:bg-[#181A20] text-[#1E2329] dark:text-[#EAECEF] min-h-screen font-sans">

<!-- ================= HEADER ================= -->
<header class="glass sticky top-0 z-50 border-b shadow-sm">
  <div class="max-w-[1600px] mx-auto px-6 h-16 flex justify-between items-center">
    <div>
      <h1 class="font-bold text-lg flex items-center gap-2 text-dark-900 dark:text-white">
        <span class="text-2xl">üèõÔ∏è</span> Global Portfolio Engine
        <span class="text-[10px] bg-brand-500 text-black px-1.5 py-0.5 rounded font-bold mono">v34.0 ULTRA</span>
      </h1>
    </div>
    
    <nav class="flex gap-1 bg-gray-100 dark:bg-dark-800 p-1 rounded-lg">
        <button onclick="UI.switchTab('dashboard')" id="btn-tab-dashboard" class="px-5 py-1.5 text-xs font-bold rounded-md bg-white dark:bg-dark-900 shadow-sm text-brand-600 transition-all">Dashboard</button>
        <button onclick="UI.switchTab('workflow')" id="btn-tab-workflow" class="px-5 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:text-brand-500 transition-all">Workflow & Logic</button>
    </nav>

    <div class="flex items-center gap-4">
        <button onclick="UI.toggleTheme()" class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-100 dark:bg-dark-800 hover:text-brand-500 transition-all">üåì</button>
    </div>
  </div>
</header>

<div class="max-w-[1600px] mx-auto px-6 py-6 grid grid-cols-12 gap-8">

<!-- ========== SIDEBAR CONFIG ========== -->
<aside class="col-span-12 lg:col-span-3 space-y-4">
<div class="glass rounded-[2rem] p-7 border-t-4 border-t-brand-500 sticky top-24 shadow-xl">
  <div class="mb-6 flex items-center justify-between">
    <h3 class="text-xs font-black uppercase text-gray-500 tracking-widest">Fund Settings</h3>
    <span class="text-[9px] bg-green-500/10 text-green-500 px-2 py-0.5 rounded font-bold uppercase tracking-tighter">Deterministic</span>
  </div>

  <!-- STRATEGY WITH HELP -->
  <div class="sidebar-section">
      <label class="opt-label flex items-center">
        Portfolio Logic
        <div class="tooltip-container">
            <span class="tooltip-icon">?</span>
            <div class="tooltip-text">‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå ‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á (Momentum) ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô (Risk Parity)</div>
        </div>
      </label>
      <select id="cfg-strategy" class="opt-input appearance-none cursor-pointer font-bold mt-1">
        <option value="ALL">‚òÖ RUN ALL (Batch Comparison)</option>
        <option value="Equal">Equal Weight (1/N)</option>
        <option value="Rank" selected>Rank All (Momentum Weights)</option>
        <option value="Top3">Top 3 Leader (Equal)</option>
        <option value="Top3Rank">Top 3 Leader (Ranked)</option>
        <option value="Top50">Top 50% Filtered Selection</option>
        <option value="AbsMom">Absolute Momentum (ROC > 0)</option>
        <option value="DualMom">Dual Momentum (Rel + Abs)</option>
        <option value="InvVol">Inverse Volatility (Risk Parity)</option>
      </select>
  </div>

  <div class="sidebar-section">
    <label class="opt-label">Backtest Window</label>
    <div class="grid grid-cols-2 gap-3 mt-1">
      <input type="date" id="cfg-start" class="opt-input text-[11px]">
      <input type="date" id="cfg-end" class="opt-input text-[11px]">
    </div>
  </div>

  <!-- ASSETS -->
  <div class="sidebar-section">
    <label class="opt-label">Universe (Add ETF Tickers)</label>
    <div class="flex gap-2 mb-2">
      <input id="cfg-add" placeholder="e.g. VOO" class="opt-input flex-1 uppercase text-xs">
      <button onclick="UI.addAsset()" class="w-12 h-11 rounded-xl bg-gray-200 dark:bg-dark-700 font-bold hover:bg-brand-500 transition-all">+</button>
    </div>
    
    <select onchange="UI.suggestAsset(this.value); this.value='';" class="opt-input text-[11px] cursor-pointer appearance-none">
        <option value="">-- ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>
        <optgroup label="Broad US & International">
            <option value="VOO">VOO (S&P 500 Index)</option>
            <option value="QQQ">QQQ (Nasdaq 100 Index)</option>
            <option value="VT">VT (World Stock Index)</option>
            <option value="VTI">VTI (Total US Market)</option>
        </optgroup>
        <optgroup label="Dividend & Sector Growth">
            <option value="SCHD">SCHD (US Dividend Growth)</option>
            <option value="SMH">SMH (Semiconductors)</option>
            <option value="XLK">XLK (Technology Sector)</option>
        </optgroup>
        <optgroup label="Fixed Income">
            <option value="BND">BND (Total Bond Market)</option>
            <option value="TLT">TLT (20+ Yr Treasury)</option>
        </optgroup>
        <optgroup label="Real Assets & Bitcoin">
            <option value="GLD">GLD (Gold Bullion)</option>
            <option value="VNQ">VNQ (US Real Estate)</option>
            <option value="BITO">BITO (Bitcoin Strategy)</option>
        </optgroup>
    </select>
    <div id="asset-list" class="flex flex-wrap gap-1.5 mt-3 max-h-[100px] overflow-y-auto custom-scrollbar pr-1"></div>
  </div>

  <div class="sidebar-section">
    <label class="opt-label">Comparison Benchmark</label>
    <input id="cfg-bench" value="IVV" class="opt-input uppercase text-xs">
  </div>

  <!-- FEES & OPTIMIZATION -->
  <div class="space-y-4 pt-2">
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="opt-label flex items-center">Lookback (D) <div class="tooltip-container"><span class="tooltip-icon">?</span><div class="tooltip-text">‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì ‡∏¢‡∏¥‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏¢‡∏¥‡πà‡∏á‡πÑ‡∏ß ‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏¢‡∏¥‡πà‡∏á‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£</div></div></label>
            <input id="cfg-lookback" value="60, 120, 252" class="opt-input">
        </div>
        <div>
            <label class="opt-label flex items-center">Rebalance (D) <div class="tooltip-container"><span class="tooltip-icon">?</span><div class="tooltip-text">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏±‡∏ô)</div></div></label>
            <input id="cfg-rebal" value="30, 90" class="opt-input">
        </div>
    </div>
    
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="opt-label text-red-500 flex items-center">Front-end (%) <div class="tooltip-container"><span class="tooltip-icon">?</span><div class="tooltip-text">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÅ‡∏£‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏ì ‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å</div></div></label>
            <input id="cfg-frontend-fee" value="1.00" type="number" step="0.01" class="opt-input text-red-500 font-bold">
        </div>
        <div>
            <label class="opt-label text-blue-500 flex items-center">Mgmt Fee (%) <div class="tooltip-container"><span class="tooltip-icon">?</span><div class="tooltip-text">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</div></div></label>
            <input id="cfg-mgmt-fee" value="1.50" type="number" step="0.01" class="opt-input text-blue-500 font-bold">
        </div>
    </div>
    <div>
        <label class="opt-label flex items-center">Trading Fee (%) <div class="tooltip-container"><span class="tooltip-icon">?</span><div class="tooltip-text">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏≠‡∏£‡πå‡∏ï (‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏° Turnover)</div></div></label>
        <input id="cfg-fee" value="0.10" type="number" step="0.01" class="opt-input text-gray-500">
    </div>
  </div>

  <button onclick="Engine.runBatch()" class="w-full bg-brand-500 py-4 mt-6 rounded-2xl font-bold text-black shadow-xl shadow-brand-500/30 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-2">
    <i class="fas fa-calculator"></i> <span>CALCULATE PORTFOLIO</span>
  </button>
</div>
</aside>

<!-- ========== MAIN CONTENT ========== -->
<div class="col-span-12 lg:col-span-9 space-y-8">

    <!-- PAGE: DASHBOARD -->
    <div id="view-dashboard" class="space-y-8 animate-fade-in">
        
        <!-- KPIs row -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
          <div class="glass p-6 rounded-3xl border-l-4 border-l-green-500 shadow-sm relative">
            <div class="text-[10px] uppercase font-bold text-gray-400 tracking-widest">Net Return (CAGR)</div>
            <div id="kpi-cagr" class="text-3xl font-bold mt-1 mono text-dark-900 dark:text-white">-</div>
            <div id="bench-cagr" class="kpi-bench-val">Bench: -</div>
          </div>
          <div class="glass p-6 rounded-3xl border-l-4 border-l-brand-500 shadow-sm">
            <div class="text-[10px] uppercase font-bold text-gray-400 tracking-widest">Sharpe Ratio</div>
            <div id="kpi-sharpe" class="text-3xl font-bold mt-1 mono text-dark-900 dark:text-white">-</div>
            <div id="bench-sharpe" class="kpi-bench-val">Bench: -</div>
          </div>
          <div class="glass p-6 rounded-3xl border-l-4 border-l-red-500 shadow-sm">
            <div class="text-[10px] uppercase font-bold text-gray-400 tracking-widest">Worst Drawdown</div>
            <div id="kpi-mdd" class="text-3xl font-bold mt-1 mono text-red-500">-</div>
            <div id="bench-mdd" class="kpi-bench-val">Bench: -</div>
          </div>
          <div class="glass p-6 rounded-3xl border-l-4 border-l-blue-500 shadow-sm">
            <div class="text-[10px] uppercase font-bold text-gray-400 tracking-widest">Avg. Turnover</div>
            <div id="kpi-turnover" class="text-3xl font-bold mt-1 mono text-blue-500">-</div>
            <div id="bench-to" class="kpi-bench-val">Bench: 0.0% (Hold)</div>
          </div>
        </div>

        <!-- Main Charts -->
        <div class="glass p-8 rounded-[2.5rem] shadow-xl space-y-6">
            <div class="flex justify-between items-center px-2">
                <h3 class="text-xs font-bold uppercase text-gray-500 tracking-widest font-sans">Net Growth & Portfolio Drawdown Waterfall</h3>
                <button onclick="UI.toggleLog()" class="text-[9px] font-bold bg-gray-100 dark:bg-dark-800 px-4 py-2 rounded-xl border dark:border-dark-700 mono">TOGGLE LOG</button>
            </div>
            <div class="h-[380px]"><canvas id="chart-equity"></canvas></div>
            <div class="h-[140px] border-t dark:border-dark-700 pt-6"><canvas id="chart-drawdown"></canvas></div>
        </div>

        <!-- Optimization Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="glass p-8 rounded-[2.5rem] shadow-xl h-[550px] flex flex-col">
                <h3 class="font-bold text-sm mb-6 border-b dark:border-dark-700 pb-4 flex justify-between items-center">
                    <span>Hyper-Parameter Sharpe Surface</span>
                    <span class="text-[9px] bg-brand-500/10 text-brand-600 px-2 py-0.5 rounded font-mono uppercase tracking-tighter">Dynamic Mapping</span>
                </h3>
                <div id="viz-surface" class="flex-1"></div>
            </div>
            <div class="glass p-8 rounded-[2.5rem] shadow-xl h-[550px] flex flex-col">
                <h3 class="font-bold text-sm mb-6 border-b dark:border-dark-700 pb-4 flex justify-between items-center">
                    <span>üé≤ Monte Carlo Forecast (1Y)</span>
                    <button onclick="UI.runMonteCarlo()" class="text-[9px] bg-brand-500 text-black px-4 py-1.5 rounded-xl font-bold uppercase tracking-wider hover:scale-105 transition-all shadow-md">Re-Simulate</button>
                </h3>
                <div id="viz-monte-dashboard" class="flex-1"></div>
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="glass p-8 rounded-[2.5rem] shadow-xl h-[500px]">
                <h3 class="font-bold text-sm mb-6 border-b dark:border-dark-700 pb-4 font-sans">Correlation Matrix (T-90)</h3>
                <div id="viz-correlation" class="h-[380px]"></div>
            </div>
            <div class="glass p-8 rounded-[2.5rem] shadow-xl h-[500px] flex flex-col">
                <h3 class="font-bold text-sm mb-6 border-b dark:border-dark-700 pb-4 flex justify-between items-center">
                    <span>Individual Asset Metrics</span>
                </h3>
                <div class="flex-1 overflow-auto custom-scrollbar">
                    <table class="w-full text-[11px] mono">
                        <thead class="bg-gray-50 dark:bg-dark-800 text-gray-400 sticky top-0">
                            <tr class="text-right">
                                <th class="text-left p-3 border-b dark:border-dark-700">Ticker</th>
                                <th class="p-3 border-b dark:border-dark-700">Volatility</th>
                                <th class="p-3 border-b dark:border-dark-700 text-red-500">Max DD</th>
                                <th class="p-3 border-b dark:border-dark-700 text-green-500">Absolute Ret</th>
                            </tr>
                        </thead>
                        <tbody id="asset-risk-table" class="divide-y dark:divide-dark-700 text-right"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Batch Matrix Explorer -->
        <div class="glass rounded-[2.5rem] overflow-hidden shadow-2xl border flex flex-col min-h-[600px]">
            <div class="px-8 py-6 border-b dark:border-dark-700 bg-gray-50/50 dark:bg-dark-800/50 flex justify-between items-center">
                <div>
                    <h3 class="text-sm font-black uppercase text-gray-600 dark:text-gray-300 tracking-widest font-sans">Batch Strategy Optimization Matrix</h3>
                    <p class="text-[10px] text-gray-400 font-sans mt-1 italic">*‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏´‡∏•‡∏±‡∏Å / ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏≠‡∏¥‡∏™‡∏£‡∏∞</p>
                </div>
                <button onclick="UI.clearFilters()" class="text-[10px] bg-white dark:bg-dark-700 px-4 py-2 rounded-xl border dark:border-dark-900 font-bold text-gray-400 hover:text-brand-500 transition-all">RESET FILTERS</button>
            </div>
            <div class="overflow-x-auto custom-scrollbar flex-1">
              <table class="w-full text-[11px] mono border-collapse" id="batch-matrix-table">
                <thead class="bg-gray-100 dark:bg-dark-900 text-gray-400 text-right sticky top-0 z-10 border-b">
                  <tr>
                    <th class="text-left p-4 sortable" onclick="UI.sortBatch('stratFull')">Strategy Model <i class="fas fa-sort"></i></th>
                    <th class="p-4 sortable" onclick="UI.sortBatch('lb')">Lookback <i class="fas fa-sort"></i></th>
                    <th class="p-4 sortable" onclick="UI.sortBatch('rb')">Rebalance <i class="fas fa-sort"></i></th>
                    <th class="p-4 sortable" onclick="UI.sortBatch('cagr')">Net CAGR <i class="fas fa-sort"></i></th>
                    <th class="p-4 sortable" onclick="UI.sortBatch('sharpe')">Sharpe Ratio <i class="fas fa-sort"></i></th>
                    <th class="p-4 sortable" onclick="UI.sortBatch('mdd')">Max Drawdown <i class="fas fa-sort"></i></th>
                  </tr>
                  <tr class="bg-gray-50 dark:bg-dark-800">
                    <th class="p-2 text-left"><input type="text" id="f-strat" placeholder="Filter..." class="filter-input" oninput="UI.applyBatchFilters()"></th>
                    <th class="p-2"><input type="number" id="f-lb" class="filter-input" oninput="UI.applyBatchFilters()"></th>
                    <th class="p-2"><input type="number" id="f-rb" class="filter-input" oninput="UI.applyBatchFilters()"></th>
                    <th class="p-2"><input type="number" id="f-cagr" class="filter-input" oninput="UI.applyBatchFilters()"></th>
                    <th class="p-2"><input type="number" id="f-sharpe" class="filter-input" oninput="UI.applyBatchFilters()"></th>
                    <th class="p-2"><input type="number" id="f-mdd" class="filter-input" oninput="UI.applyBatchFilters()"></th>
                  </tr>
                </thead>
                <tbody id="batch-table-body" class="divide-y dark:divide-dark-700 text-right"></tbody>
              </table>
            </div>
        </div>

        <!-- Heatmaps Section -->
        <div class="glass rounded-[2.5rem] overflow-hidden shadow-xl p-8 space-y-12 border">
            <div><h3 class="text-xs font-bold uppercase text-green-600 mb-6 tracking-widest font-sans border-b pb-2">Monthly Returns Heatmap (%)</h3><div id="heatmap-return-container" class="overflow-x-auto custom-scrollbar"></div></div>
            <div><h3 class="text-xs font-bold uppercase text-red-500 mb-6 tracking-widest font-sans border-b pb-2">Monthly Max Drawdown Intensity (%)</h3><div id="heatmap-drawdown-container" class="overflow-x-auto custom-scrollbar"></div></div>
        </div>

        <!-- Allocation Logs -->
        <div class="glass rounded-[2.5rem] overflow-hidden shadow-xl border">
            <div class="px-8 py-5 border-b dark:border-dark-700 bg-gray-50/30">
                <h3 class="text-xs font-bold uppercase text-gray-500 tracking-widest font-sans">Full Rebalance Logs & Dynamic Allocation Matrix</h3>
            </div>
            <div class="overflow-x-auto max-h-[600px] custom-scrollbar">
                <table class="w-full text-[11px] mono">
                    <thead class="bg-gray-50 dark:bg-dark-800 text-gray-400 sticky top-0 border-b">
                        <tr class="text-left">
                            <th class="p-5 w-32">Date</th>
                            <th class="p-5 w-24">TO %</th>
                            <th class="p-5">Allocations Analysis (%)</th>
                        </tr>
                    </thead>
                    <tbody id="log-table" class="divide-y dark:divide-dark-700"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PAGE: WORKFLOW & LOGIC -->
    <div id="view-workflow" class="hidden space-y-12 animate-fade-in pb-20 font-sans">
        <div class="glass p-12 rounded-[4rem] shadow-2xl border border-brand-500/20 max-w-6xl mx-auto">
            <div class="text-center mb-16">
                <h2 class="text-4xl font-bold mb-4 tracking-tight">Strategy Architecture & Logic</h2>
                <p class="text-gray-500 text-lg italic">‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°</p>
            </div>

            <div class="space-y-16">
                <!-- Fee Logic -->
                <div class="step-card">
                    <h4 class="text-2xl font-bold text-red-500 mb-4">Institutional Multi-Fee Engine</h4>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                        <div class="space-y-6">
                            <div class="formula-box p-6 border-red-500/30">
                                <div class="text-[10px] font-bold text-red-500 uppercase">1. Front-end Fee (‡πÅ‡∏£‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤)</div>
                                <div class="mono text-lg font-bold text-center py-2 underline decoration-red-500/30 decoration-double">
                                    C<sub>start</sub> = C<sub>initial</sub> √ó (1 - Fee<sub>front</sub>)
                                </div>
                                <p class="text-[11px] text-gray-400 mt-2 font-sans italic">‡∏´‡∏±‡∏Å‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô ($T=0$)</p>
                            </div>
                            <div class="formula-box p-6 border-blue-500/30">
                                <div class="text-[10px] font-bold text-blue-500 uppercase">2. Management Fee (‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£)</div>
                                <div class="mono text-lg font-bold text-center py-2 underline decoration-blue-500/30">
                                    NAV<sub>daily</sub> = NAV<sub>prev</sub> √ó (1 - (Fee<sub>mgmt</sub> / 365))
                                </div>
                                <p class="text-[11px] text-gray-400 mt-2 font-sans italic">‡∏´‡∏±‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á‡∏û‡∏≠‡∏£‡πå‡∏ï (NAV Net Expenses)</p>
                            </div>
                            <div class="formula-box p-6">
                                <div class="text-[10px] font-bold text-gray-500 uppercase font-sans">3. Trading Fee (‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢)</div>
                                <div class="mono text-lg font-bold text-center py-2">
                                    Cost = Turnover √ó Fee<sub>trade</sub>
                                </div>
                                <p class="text-[11px] text-gray-400 mt-2 font-sans italic">‡∏´‡∏±‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏à‡∏£‡∏¥‡∏á (Rebalance)</p>
                            </div>
                        </div>
                        <div class="flex flex-col justify-center">
                            <h5 class="font-black text-sm mb-4 font-sans uppercase tracking-tighter">Numerical Cost Walkthrough:</h5>
                            <div class="mono text-xs space-y-4 bg-white/50 dark:bg-black/20 p-8 rounded-[2rem] border dark:border-dark-700 shadow-inner">
                                <div class="text-dark-900 dark:text-white font-bold border-b pb-1">Fund Simulation Example:</div>
                                <div>- ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô: $1,000</div>
                                <div>- Front-end Fee (1.0%): <span class="text-red-500">-$10.00</span></div>
                                <div class="text-brand-600 font-bold">-> Net Start (T=0): $990.00</div>
                                <div class="pt-4 border-t dark:border-gray-800 leading-relaxed">
                                    - ‡∏ñ‡∏∑‡∏≠‡∏û‡∏≠‡∏£‡πå‡∏ï 1 ‡∏õ‡∏µ (Mgmt Fee 1.5%):<br>
                                    - ‡∏´‡∏±‡∏Å NAV ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ~0.0041%<br>
                                    - <span class="text-blue-500">Total Exp: ~$14.85</span>
                                </div>
                                <div class="pt-4 border-t dark:border-gray-800">
                                    - ‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏≠‡∏£‡πå‡∏ï Rebalance (TO 50%):<br>
                                    - Trading Fee (0.10%):<br>
                                    - Cost = 990 * 0.5 * 0.001 = <span class="text-orange-500">-$0.49</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Strategic Scenarios -->
                <div class="step-card">
                    <h4 class="text-2xl font-bold text-purple-600 mb-8">Strategic Scenarios: Allocation Breakdown</h4>
                    <div class="p-10 bg-brand-500/5 rounded-[3rem] border border-brand-500/20 mb-12">
                        <h5 class="font-bold text-xl mb-4">Sample Assets Assessment Case (A, B, C, D)</h5>
                        <div class="overflow-x-auto mb-10 border rounded-2xl bg-white dark:bg-dark-900 shadow-sm">
                            <table class="w-full text-[12px] mono text-left border-collapse">
                                <thead class="bg-gray-50 dark:bg-dark-800 text-gray-500 border-b">
                                    <tr><th class="p-4">Ticker</th><th class="p-4 text-center">Momentum ROC (60D)</th><th class="p-4 text-center">Volatility œÉ</th><th class="p-4 text-center">Relative Rank</th></tr>
                                </thead>
                                <tbody class="divide-y dark:divide-gray-800">
                                    <tr><td class="p-4 font-bold">Asset A (VOO)</td><td class="p-4 text-center text-green-500">+12%</td><td class="p-4 text-center">15.0%</td><td class="p-4 text-center font-bold">#2</td></tr>
                                    <tr><td class="p-4 font-bold">Asset B (QQQ)</td><td class="p-4 text-center text-green-500">+25%</td><td class="p-4 text-center">25.0%</td><td class="p-4 text-center font-bold">#1</td></tr>
                                    <tr><td class="p-4 font-bold">Asset C (BND)</td><td class="p-4 text-center text-red-400">-2%</td><td class="p-4 text-center font-bold">4.0%</td><td class="p-4 text-center font-bold">#4</td></tr>
                                    <tr><td class="p-4 font-bold">Asset D (GLD)</td><td class="p-4 text-center text-green-500">+8%</td><td class="p-4 text-center">12.0%</td><td class="p-4 text-center font-bold">#3</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="strat-card-info"><h6 class="font-bold text-purple-600 mb-2">1. Equal Weight (1/N)</h6><p class="text-[11px] text-gray-400">Alloc A:25, B:25, C:25, D:25</p></div>
                            <div class="strat-card-info"><h6 class="font-bold text-purple-600 mb-2">2. Rank All</h6><p class="text-[11px] text-gray-400">Alloc B:40, A:30, D:20, C:10 (Linear)</p></div>
                            <div class="strat-card-info"><h6 class="font-bold text-purple-600 mb-2">3. Top 3 Equal</h6><p class="text-[11px] text-gray-400">Select B, A, D | Weight: 33.3% each</p></div>
                            <div class="strat-card-info"><h6 class="font-bold text-purple-600 mb-2">4. Top 3 Rank Weighted</h6><p class="text-[11px] text-gray-400">B:50, A:33, D:17 (C:0)</p></div>
                            <div class="strat-card-info"><h6 class="font-bold text-purple-600 mb-2">5. Top 50% Filter</h6><p class="text-[11px] text-gray-400">Top Half (B, A): 50% Each</p></div>
                            <div class="strat-card-info"><h6 class="font-bold text-purple-600 mb-2">6. Abs Momentum</h6><p class="text-[11px] text-gray-400">Positive Mom: B, A, D (33.3% each)</p></div>
                            <div class="strat-card-info"><h6 class="font-bold text-purple-600 mb-2">7. Dual Momentum</h6><p class="text-[11px] text-gray-400">Top 3 + Positive ROC: B, A, D (Equal)</p></div>
                            <div class="strat-card-info"><h6 class="font-bold text-purple-600 mb-2">8. Inverse Volatility</h6><p class="text-[11px] text-gray-400">W = 1/œÉ: C gets ~54% (Lowest Vol)</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
</div>

<!-- ================= LOADER ================= -->
<div id="loader" class="fixed inset-0 bg-white/95 dark:bg-dark-900/95 z-[100] hidden flex flex-col items-center justify-center backdrop-blur-md">
    <div class="w-16 h-16 border-4 border-brand-500 border-t-transparent rounded-full animate-spin"></div>
    <p class="mt-6 font-bold mono text-sm tracking-[0.3em] animate-pulse uppercase" id="loader-text">Quant engine processing...</p>
</div>

<script>
/* =========================================================
   QUANT ENGINE CORE
========================================================= */

const GLOBAL_UNIVERSE = ["VOO", "QQQ", "GLD", "BND", "VNQ", "VT", "SMH", "SCHD"];

const STRAT_NAMES = {
    Equal: "Equal Weight (1/N)",
    Rank: "Rank All (Momentum Weights)",
    Top3: "Top 3 Leader (Equal)",
    Top3Rank: "Top 3 Leader (Ranked)",
    Top50: "Top 50% Selection",
    AbsMom: "Absolute Momentum (ROC > 0)",
    DualMom: "Dual Momentum (Rel + Abs)",
    InvVol: "Inverse Volatility (Risk Parity)"
};

class QuantEngine {
  constructor(){
    this.universe = [...GLOBAL_UNIVERSE];
    this.allPrices = {}; 
    this.dates = [];
    this.results = [];
    this.benchStats = { cagr: 0, sharpe: 0, mdd: 0 };
  }

  resetUniverse(){ this.universe = [...GLOBAL_UNIVERSE]; UI.renderAssets(); }

  // Hash-based Deterministic Seed Generator
  getSeededRandom(seedStr) {
      let hash = 0;
      for (let i = 0; i < seedStr.length; i++) {
          hash = ((hash << 5) - hash) + seedStr.charCodeAt(i);
          hash |= 0;
      }
      return function() {
          let t = hash += 0x6D2B79F5;
          t = Math.imul(t ^ t >>> 15, t | 1);
          t ^= t + Math.imul(t ^ t >>> 7, t | 61);
          return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
  }

  async fetchAssetData(symbol){
    const chars = {
        VOO:  { mu: 0.00042, sigma: 0.010 }, QQQ:  { mu: 0.00055, sigma: 0.014 },
        VT:   { mu: 0.00035, sigma: 0.009 }, VTI:  { mu: 0.00042, sigma: 0.010 },
        VEU:  { mu: 0.00025, sigma: 0.011 }, EEM:  { mu: 0.00020, sigma: 0.015 },
        SMH:  { mu: 0.00078, sigma: 0.018 }, ARKK: { mu: 0.00030, sigma: 0.022 },
        BND:  { mu: 0.00005, sigma: 0.003 }, TLT:  { mu: 0.00010, sigma: 0.009 },
        GLD:  { mu: 0.00022, sigma: 0.008 }, VNQ:  { mu: 0.00015, sigma: 0.012 },
        IVV:  { mu: 0.00045, sigma: 0.010 }, SCHD: { mu: 0.00040, sigma: 0.009 },
        BITO: { mu: 0.00110, sigma: 0.035 }, XLK:  { mu: 0.00065, sigma: 0.015 }
    };
    
    const char = chars[symbol] || { mu: 0.0003, sigma: 0.012 };
    const rand = this.getSeededRandom(symbol); // FIXED SEED PER SYMBOL
    const days = 3000; 
    const history = []; let price = 100;
    const start = new Date(); start.setDate(start.getDate() - days);
    
    for(let i=0; i<days; i++){
        const u1 = rand(), u2 = rand();
        const z = Math.sqrt(-2.0 * Math.log(u1 || 1e-9)) * Math.cos(2.0 * Math.PI * (u2 || 1e-9));
        price *= Math.exp((char.mu - 0.5 * char.sigma**2) + char.sigma * z);
        const d = new Date(start); d.setDate(d.getDate() + i);
        history.push({ date: d.toISOString().slice(0, 10), price });
    }
    return history;
  }

  async runBatch(){
    UI.loading(true, "VIRTUALIZING DETERMINISTIC MARKETS...");
    const cfg = UI.getParams();
    const allTickers = [...new Set([...this.universe, cfg.bench])];
    const raw = await Promise.all(allTickers.map(s => this.fetchAssetData(s)));
    const dateSet = new Set(); raw.forEach(r => r.forEach(x => dateSet.add(x.date)));
    this.dates = [...dateSet].sort();
    
    this.allPrices = {};
    allTickers.forEach((s, idx) => {
        const history = raw[idx];
        const lookup = {}; history.forEach(h => lookup[h.date] = h.price);
        let last = history[0]?.price || 100;
        this.allPrices[s] = this.dates.map(d => { if(lookup[d]) last = lookup[d]; return last; });
    });

    const userStartIdx = this.dates.findIndex(d => d >= cfg.start);
    const endIdx = this.dates.findIndex(d => d > cfg.end);
    const sliceEnd = (endIdx === -1) ? this.dates.length : endIdx;
    
    if(userStartIdx === -1 || sliceEnd <= userStartIdx) { alert("Selected range unavailable."); UI.loading(false); return; }

    const strats = cfg.strategy === "ALL" ? Object.keys(STRAT_NAMES) : [cfg.strategy];
    const returns = {}; this.universe.forEach(s => { 
        const p = this.allPrices[s]; returns[s] = [0]; 
        for(let i=1; i<p.length; i++) returns[s].push(p[i]/p[i-1]-1); 
    });

    const assetRiskBody = document.getElementById('asset-risk-table');
    assetRiskBody.innerHTML = '';
    this.universe.forEach(s => {
        const p = this.allPrices[s].slice(userStartIdx, sliceEnd);
        const rets = []; for(let i=1; i<p.length; i++) rets.push(p[i]/p[i-1]-1);
        const vol = math.std(rets) * Math.sqrt(252) * 100;
        const totRet = (p[p.length-1]/p[0] - 1) * 100;
        let pk = 0, mdd = 0; p.forEach(v => { if(v > pk) pk = v; const dd = (v - pk)/pk; if(dd < mdd) mdd = dd; });
        assetRiskBody.innerHTML += `<tr><td class="p-3 text-left font-bold text-brand-600">${s}</td><td class="p-3">${vol.toFixed(1)}%</td><td class="p-3 text-red-500">${(mdd*100).toFixed(1)}%</td><td class="p-3 text-green-500">${totRet.toFixed(1)}%</td></tr>`;
    });

    this.results = [];
    const dailyMgmtFee = (cfg.mgmtFee / 100) / 365;

    for(const stratKey of strats){
      for(const lb of cfg.lookbacks){
        for(const rb of cfg.rebals){
          let eq = 1000 * (1 - cfg.frontEndFee / 100);
          let curve = [], w = {}, logs = [], totalTO = 0, rebCount = 0;
          this.universe.forEach(k => w[k] = 0);
          for(let t = userStartIdx; t < sliceEnd; t++){
            let dRet = 0; this.universe.forEach(k => dRet += (w[k] || 0) * (returns[k][t] || 0));
            eq *= (1 + dRet);
            eq *= (1 - dailyMgmtFee);
            if((t - userStartIdx) % rb === 0){
                const sigs = {}, vols = {};
                this.universe.forEach(k => {
                    sigs[k] = this.allPrices[k][t] / (this.allPrices[k][t-lb] || this.allPrices[k][0]) - 1;
                    vols[k] = math.std(returns[k].slice(Math.max(0, t-20), t+1)) || 0.01;
                });
                const nw = this.getWeights(stratKey, sigs, vols);
                let to = 0; this.universe.forEach(k => to += Math.abs((nw[k] || 0) - (w[k] || 0)));
                eq *= (1 - (to * cfg.fee/100));
                if(to > 0.001) { totalTO += to; rebCount++; logs.push({ date: this.dates[t], to, alloc: {...nw} }); }
                w = nw;
            }
            curve.push(eq);
          }
          this.results.push({ 
            strat: stratKey, stratFull: STRAT_NAMES[stratKey], lb, rb, curve, logs, 
            dates: this.dates.slice(userStartIdx, sliceEnd), 
            avgTO: (totalTO / Math.max(1, rebCount) * 100).toFixed(1), 
            ...this.calcStats(curve) 
          });
        }
      }
    }
    const bPrice = this.allPrices[cfg.bench].slice(userStartIdx, sliceEnd);
    this.benchStats = this.calcStats(bPrice.map(v => (v/bPrice[0])*1000));
    this.results.sort((a,b) => b.sharpe - a.sharpe);
    UI.renderBatchTable();
    UI.selectResult(0);
    UI.loading(false);
  }

  getWeights(type, sig, vol){
    const keys = this.universe;
    let items = keys.map(k => ({k, val: sig[k], vol: vol[k]})).filter(x => !isNaN(x.val));
    items.sort((a,b) => b.val - a.val);
    let w = {}; keys.forEach(k => w[k] = 0);
    if(type === "Equal") items.forEach(x => w[x.k] = 1/items.length);
    else if(type === "Rank") { const N = items.length, S = N*(N+1)/2; items.forEach((x,i) => w[x.k] = (N-i)/S); }
    else if(type === "Top3") { const K = Math.min(3, items.length); items.slice(0, K).forEach(x => w[x.k] = 1/K); }
    else if(type === "Top3Rank") { const K = Math.min(3, items.length), S = K*(K+1)/2; items.slice(0, K).forEach((x,i) => w[x.k] = (K-i)/S); }
    else if(type === "Top50") { const K = Math.ceil(items.length/2); items.slice(0, K).forEach(x => w[x.k] = 1/K); }
    else if(type === "AbsMom") { const act = items.filter(x => x.val > 0); if(act.length) act.forEach(x => w[x.k] = 1/act.length); }
    else if(type === "DualMom") { const act = items.filter(x => x.val > 0); const K = Math.min(act.length, 3); if(act.length) act.slice(0, K).forEach(x => w[x.k] = 1/K); }
    else if(type === "InvVol") { let S = 0; items.forEach(x => S += 1/(x.vol || 0.01)); items.forEach(x => w[x.k] = (1/(x.vol || 0.01))/S); }
    return w;
  }

  calcStats(curve){
    if(!curve.length) return {cagr:0, sharpe:0, mdd:0};
    const rets = []; for(let i=1; i<curve.length; i++) rets.push(curve[i]/curve[i-1]-1);
    const cagr = (Math.pow(curve[curve.length-1]/curve[0], 252/curve.length)-1)*100;
    const vol = math.std(rets) * Math.sqrt(252);
    const sharpe = vol === 0 ? 0 : (math.mean(rets) * 252) / vol;
    let pk = 0, mdd = 0; curve.forEach(v => { if(v > pk) pk = v; const dd = (v - pk)/pk; if(dd < mdd) mdd = dd; });
    return { cagr: cagr.toFixed(2), sharpe: sharpe.toFixed(2), mdd: (mdd * 100).toFixed(2) };
  }
}

/* =========================================================
   UI CONTROLLER
========================================================= */

const UI = {
    chartEq: null, chartDD: null, isLog: false, selectedIdx: 0,
    sortCol: 'sharpe', sortDir: 'desc',

    init(){
        this.renderAssets(); this.switchTab('dashboard');
        const end = new Date(); const start = new Date(); start.setFullYear(end.getFullYear() - 3);
        document.getElementById('cfg-start').value = start.toISOString().slice(0,10);
        document.getElementById('cfg-end').value = end.toISOString().slice(0,10);
    },

    getParams(){
        const p = {}; ['cfg-strategy', 'cfg-start', 'cfg-end', 'cfg-bench', 'cfg-lookback', 'cfg-rebal', 'cfg-fee', 'cfg-frontend-fee', 'cfg-mgmt-fee'].forEach(id => { const el = document.getElementById(id); p[id.replace('cfg-','')] = el ? el.value : null; });
        return {
            ...p, bench: (p.bench || "IVV").toUpperCase().trim(),
            lookbacks: p.lookback ? p.lookback.split(',').map(v => parseInt(v.trim())) : [60],
            rebals: p.rebal ? p.rebal.split(',').map(v => parseInt(v.trim())) : [30],
            fee: parseFloat(p.fee || 0.1), 
            frontEndFee: parseFloat(p['frontend-fee'] || 0),
            mgmtFee: parseFloat(p['mgmt-fee'] || 0),
            leverage: 1
        };
    },

    switchTab(id){
        ['dashboard', 'workflow'].forEach(v => {
            const view = document.getElementById(`view-${v}`); const btn = document.getElementById(`btn-tab-${v}`);
            if(view) view.classList.add('hidden'); if(btn) btn.className = "px-5 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:text-brand-500 transition-all";
        });
        const tv = document.getElementById(`view-${id}`); const tb = document.getElementById(`btn-tab-${id}`);
        if(tv) tv.classList.remove('hidden'); if(tb) tb.className = "px-5 py-1.5 text-xs font-bold rounded-md bg-white dark:bg-dark-900 shadow-sm text-brand-600 transition-all";
        if(Engine.results.length && id === 'dashboard') { UI.renderSurface(); UI.runMonteCarlo(); }
    },

    suggestAsset(s){ if(!s) return; document.getElementById('cfg-add').value = s; this.addAsset(); },
    addAsset(){ const i = document.getElementById('cfg-add'); if(!i) return; const v = i.value.trim().toUpperCase(); if(v && !Engine.universe.includes(v)){ Engine.universe.push(v); this.renderAssets(); } i.value = ''; },
    removeAsset(s){ Engine.universe = Engine.universe.filter(u => u !== s); this.renderAssets(); },
    renderAssets(){ const l = document.getElementById('asset-list'); if(l) l.innerHTML = Engine.universe.map(a => `<span class="bg-white dark:bg-dark-800 border dark:border-dark-700 px-2 py-1 rounded-md text-[10px] mono font-bold flex items-center gap-1 shadow-sm">${a} <button onclick="UI.removeAsset('${a}')" class="text-red-500 hover:text-red-700 font-bold ml-1">√ó</button></span>`).join(''); },
    loading(s, t="..."){ const elT = document.getElementById('loader-text'); const elL = document.getElementById('loader'); if(elT) elT.innerText = t; if(elL) s ? elL.classList.remove('hidden') : elL.classList.add('hidden'); },
    toggleTheme(){ document.body.classList.toggle('dark'); if(Engine.results.length) this.selectResult(this.selectedIdx); },
    toggleLog(){ this.isLog = !this.isLog; if(Engine.results[this.selectedIdx]) this.renderEquity(Engine.results[this.selectedIdx]); },

    sortBatch(col){
        if(this.sortCol === col) this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
        else { this.sortCol = col; this.sortDir = 'desc'; }
        this.renderBatchTable();
    },

    applyBatchFilters(){ this.renderBatchTable(); },
    clearFilters(){ ['f-strat', 'f-lb', 'f-rb', 'f-cagr', 'f-sharpe', 'f-mdd', 'f-to'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; }); this.renderBatchTable(); },

    renderBatchTable(){
        const b = document.getElementById('batch-table-body'); if(!b || !Engine.results.length) return;
        const fs = document.getElementById('f-strat').value.toLowerCase();
        const flb = parseFloat(document.getElementById('f-lb').value) || -Infinity;
        const frb = parseFloat(document.getElementById('f-rb').value) || -Infinity;
        const fcagr = parseFloat(document.getElementById('f-cagr').value) || -Infinity;
        const fsharpe = parseFloat(document.getElementById('f-sharpe').value) || -Infinity;
        const fmdd = parseFloat(document.getElementById('f-mdd').value) || Infinity;

        let data = Engine.results.filter(r => {
            return r.stratFull.toLowerCase().includes(fs) && r.lb >= flb && r.rb >= frb &&
                   parseFloat(r.cagr) >= fcagr && parseFloat(r.sharpe) >= fsharpe &&
                   Math.abs(parseFloat(r.mdd)) <= Math.abs(fmdd);
        });

        data.sort((a,b) => {
            let v1 = a[this.sortCol], v2 = b[this.sortCol];
            if(['cagr', 'sharpe', 'mdd', 'avgTO', 'lb', 'rb'].includes(this.sortCol)){ v1 = parseFloat(v1); v2 = parseFloat(v2); }
            if(this.sortDir === 'asc') return v1 > v2 ? 1 : -1;
            return v1 < v2 ? 1 : -1;
        });

        const ths = document.querySelectorAll('#batch-matrix-table th.sortable');
        ths.forEach(th => {
            th.classList.remove('sorted-asc', 'sorted-desc');
            const colMatch = th.getAttribute('onclick').match(/'([^']+)'/);
            if(colMatch && colMatch[1] === this.sortCol) th.classList.add(this.sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
        });

        if(!data.length){ b.innerHTML = '<tr><td colspan="7" class="py-20 text-center text-gray-400 italic">No matches.</td></tr>'; return; }
        b.innerHTML = data.map((r, i) => {
            const origIdx = Engine.results.findIndex(orig => orig === r);
            return `<tr onclick="UI.selectResult(${origIdx})" class="cursor-pointer hover:bg-brand-500/10 transition-colors ${origIdx===this.selectedIdx?'bg-brand-500/15 font-bold':''}">
                <td class="text-left p-4 font-bold text-dark-900 dark:text-white">${r.stratFull}</td><td class="p-4">${r.lb}</td><td class="p-4">${r.rb}</td>
                <td class="p-4 text-green-500">${r.cagr}%</td><td class="p-4 text-brand-600 font-bold">${r.sharpe}</td>
                <td class="p-4 text-red-500">${r.mdd}%</td><td class="p-4 text-blue-500">${r.avgTO}%</td></tr>`;
        }).join('');
    },

    selectResult(idx){
        this.selectedIdx = idx; const res = Engine.results[idx]; if(!res) return;
        const ks = { 'kpi-cagr': res.cagr+"%", 'kpi-sharpe': res.sharpe, 'kpi-mdd': res.mdd+"%", 'kpi-turnover': res.avgTO+"%" };
        Object.entries(ks).forEach(([id, v]) => { const el = document.getElementById(id); if(el) el.innerText = v; });
        const bps = { 'bench-cagr': `Bench: ${Engine.benchStats.cagr}%`, 'bench-sharpe': `Bench: ${Engine.benchStats.sharpe}`, 'bench-mdd': `Bench: ${Engine.benchStats.mdd}%` };
        Object.entries(bps).forEach(([id, v]) => { const el = document.getElementById(id); if(el) el.innerText = v; });
        this.renderEquity(res); this.renderLogs(res.logs); this.renderHeatmaps(res);
        this.renderCorrelation(); this.renderDrawdownChart(res);
        this.renderBatchTable(); UI.renderSurface(); UI.runMonteCarlo();
    },

    renderLogs(logs){
        const b = document.getElementById('log-table'); if(!b) return;
        b.innerHTML = logs.slice().reverse().map(l => {
            const table = `<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">` + Object.entries(l.alloc).filter(([k,v])=>v>0.001).map(([k,v])=>`<div class="bg-gray-50 dark:bg-dark-900/50 p-2 rounded border dark:border-dark-700 flex justify-between shadow-sm"><span class="font-bold text-gray-400 text-[10px]">${k}</span><span class="text-brand-600 font-bold">${(v*100).toFixed(1)}%</span></div>`).join('') + `</div>`;
            return `<tr><td class="p-5 text-gray-400 font-bold">${l.date}</td><td class="p-5 font-bold text-blue-500">${(l.to*100).toFixed(1)}%</td><td class="p-5">${table}</td></tr>`;
        }).join('');
    },

    renderEquity(res){
        const ctx = document.getElementById('chart-equity').getContext('2d'); if(this.chartEq) this.chartEq.destroy();
        const cfg = UI.getParams(); const bAll = Engine.allPrices[cfg.bench]; const sIdx = Engine.dates.findIndex(d => d === res.dates[0]);
        const bench = bAll.slice(sIdx, sIdx + res.curve.length).map(v => (v/bAll[sIdx])*1000);
        this.chartEq = new Chart(ctx, { type: 'line', data: { labels: res.dates, datasets: [{ label: 'Managed Portfolio (Net)', data: res.curve, borderColor: '#FCD535', backgroundColor: 'rgba(252,213,53,0.1)', borderWidth: 3.5, fill: true, pointRadius: 0 }, { label: 'Benchmark Index (Raw)', data: bench, borderColor: '#94a3b8', borderDash: [5,5], borderWidth: 1.5, pointRadius: 0, fill: false }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { type: this.isLog ? 'logarithmic' : 'linear', grid: { color: document.body.classList.contains('dark') ? '#2B3139' : '#F0F3F5' }, ticks: { color: '#848E9C' } }, x: { display: false } }, plugins: { legend: { labels: { color: document.body.classList.contains('dark') ? '#EAECEF' : '#1E2329', font: { weight: 'bold' } } } } } });
    },

    renderDrawdownChart(res){
        const ctx = document.getElementById('chart-drawdown').getContext('2d'); if(this.chartDD) this.chartDD.destroy();
        let pk = 0; const dd = res.curve.map(v => { if(v > pk) pk = v; return (v - pk)/pk * 100; });
        this.chartDD = new Chart(ctx, { type: 'line', data: { labels: res.dates, datasets: [{ data: dd, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.2)', fill: true, pointRadius: 0, borderWidth: 1.5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { max: 0, ticks: { callback: v => v + '%' } }, x: { ticks: { color: '#848E9C', maxTicksLimit: 12 } } } } });
    },

    renderCorrelation(){
        const assets = Engine.universe; const rets = assets.map(s => { const p = Engine.allPrices[s].slice(-90); const r = []; for(let i=1; i<p.length; i++) r.push(p[i]/p[i-1]-1); return r; });
        const z = assets.map((a1, i) => assets.map((a2, j) => { if(i === j) return 1; const r1 = rets[i], r2 = rets[j], m1 = math.mean(r1), m2 = math.mean(r2); let num = 0, d1 = 0, d2 = 0; for(let k=0; k<r1.length; k++){ num += (r1[k]-m1)*(r2[k]-m2); d1 += (r1[k]-m1)**2; d2 += (r2[k]-m2)**2; } return num / Math.sqrt(d1 * d2); }));
        Plotly.newPlot('viz-correlation', [{ z, x: assets, y: assets, type: 'heatmap', colorscale: 'RdBu', zmin: -1, zmax: 1 }], { margin: { l: 60, r: 10, b: 40, t: 10 }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: document.body.classList.contains('dark') ? '#EAECEF' : '#1E2329' } }, { displayModeBar: false });
    },

    renderHeatmaps(res){
        const mons = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const dR = {}, dD = {}; let pk = 0;
        res.dates.forEach((d, i) => {
            const y = d.slice(0, 4); const m = parseInt(d.slice(5, 7)) - 1;
            const val = res.curve[i]; const prev = i > 0 ? res.curve[i-1] : val;
            if(val > pk) pk = val; const dd = (val - pk)/pk;
            if(!dR[y]) dR[y] = new Array(12).fill(null); if(!dD[y]) dD[y] = new Array(12).fill(null);
            if(dR[y][m] === null) dR[y][m] = 1; dR[y][m] *= (1 + (val/prev - 1));
            if(dD[y][m] === null || dd < dD[y][m]) dD[y][m] = dd;
        });
        const years = Object.keys(dR).sort().reverse();
        let hR = `<table class="heatmap-table"><thead><tr><th>Year</th>${mons.map(m=>`<th>${m}</th>`).join('')}<th>Total</th></tr></thead><tbody>`;
        years.forEach(y => {
            let yT = 1; hR += `<tr><td class="font-bold text-gray-400 text-xs">${y}</td>`;
            for(let i=0; i<12; i++){
                const mR = dR[y][i]; if(mR === null) { hR += `<td>-</td>`; continue; }
                const p = (mR - 1) * 100; yT *= mR;
                const bg = p >= 0 ? `rgba(34, 197, 94, ${Math.min(p/10,1)})` : `rgba(239, 68, 68, ${Math.min(Math.abs(p)/10,1)})`;
                hR += `<td style="background:${bg}; color:${Math.abs(p)>5?'#fff':'inherit'}">${p.toFixed(1)}%</td>`;
            }
            hR += `<td class="font-bold text-xs" style="color:${yT>=1?'#22c55e':'#ef4444'}">${((yT-1)*100).toFixed(1)}%</td></tr>`;
        });
        document.getElementById('heatmap-return-container').innerHTML = hR + `</tbody></table>`;
        let hD = `<table class="heatmap-table"><thead><tr><th>Year</th>${mons.map(m=>`<th>${m}</th>`).join('')}</tr></thead><tbody>`;
        years.forEach(y => {
            hD += `<tr><td class="font-bold text-gray-400 text-xs">${y}</td>`;
            for(let i=0; i<12; i++){
                const mVal = dD[y][i]; if(mVal === null) { hD += `<td>-</td>`; continue; }
                const p = mVal * 100; const bg = `rgba(239, 68, 68, ${Math.min(Math.abs(p)/20,1)})`;
                hD += `<td style="background:${bg}; color:${Math.abs(p)>10?'#fff':'inherit'}">${p.toFixed(1)}%</td>`;
            }
            hD += `</tr>`;
        });
        document.getElementById('heatmap-drawdown-container').innerHTML = hD + `</tbody></table>`;
    },

    runMonteCarlo(){
        const res = Engine.results[this.selectedIdx]; if(!res) return;
        const rets = []; for(let i=1; i<res.curve.length; i++) rets.push(res.curve[i]/res.curve[i-1]-1);
        const mu = math.mean(rets), sig = math.std(rets); const paths = [];
        for(let s=0; s<40; s++){
            let cur = res.curve[res.curve.length-1], p = [cur];
            for(let d=0; d<252; d++){
                const u1 = Math.random(), u2 = Math.random();
                const z = Math.sqrt(-2.0 * Math.log(u1 || 1e-9)) * Math.cos(2.0 * Math.PI * (u2 || 1e-9));
                cur *= Math.exp((mu - 0.5 * sig**2) + sig * z); p.push(cur);
            }
            paths.push(p);
        }
        Plotly.newPlot('viz-monte-dashboard', paths.map(p => ({ y: p, type: 'scatter', mode: 'lines', line: { width: 1, color: 'rgba(252, 213, 53, 0.15)' }, showlegend: false })), { margin: { l: 40, r: 10, b: 30, t: 10 }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: document.body.classList.contains('dark') ? '#EAECEF' : '#1E2329' } }, { displayModeBar: false });
    },

    renderSurface(){
        if(!Engine.results.length) return;
        const currentStrat = Engine.results[this.selectedIdx].strat;
        const filtered = Engine.results.filter(r => r.strat === currentStrat);
        const lbs = [...new Set(filtered.map(r => r.lb))].sort((a,b)=>a-b);
        const rbs = [...new Set(filtered.map(r => r.rb))].sort((a,b)=>a-b);
        
        const z = rbs.map(rb => lbs.map(lb => {
            const m = filtered.find(r => r.lb === lb && r.rb === rb);
            return m ? parseFloat(m.sharpe) : null;
        }));

        const isDark = document.body.classList.contains('dark');
        Plotly.newPlot('viz-surface', [{
            z: z, x: lbs, y: rbs, type: 'surface', colorscale: 'Viridis',
            colorbar: { title: 'Sharpe Ratio', tickfont: { color: isDark ? '#EAECEF' : '#1E2329' } }
        }], {
            margin: { l: 0, r: 0, b: 0, t: 0 }, paper_bgcolor: 'rgba(0,0,0,0)',
            scene: {
                xaxis: { title: 'Lookback', color: isDark ? '#848E9C' : '#1E2329' },
                yaxis: { title: 'Rebal', color: isDark ? '#848E9C' : '#1E2329' },
                zaxis: { title: 'Sharpe', color: isDark ? '#848E9C' : '#1E2329' }
            }
        }, { displayModeBar: false });
    }
};

const Engine = new QuantEngine();
window.onload = () => UI.init();
</script>
</body>
</html>
